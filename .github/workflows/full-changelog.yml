name: Generate Full Changelog from PRs and Issues

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  full-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Generate CHANGELOG.full.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "# Full Change Log" > CHANGELOG.full.md
          echo "" >> CHANGELOG.full.md
          echo "Release: $TAG" >> CHANGELOG.full.md
          echo "" >> CHANGELOG.full.md

          # 1. get PR numbers included in this release
          PRS=$(gh api \
            repos/$REPO/releases/tags/$TAG \
            --jq '.body' \
            | grep -oE '#[0-9]+' \
            | tr -d '#' \
            | sort -u)

          for PR in $PRS; do
            echo "## $(gh api repos/$REPO/pulls/$PR --jq '.title') (#$PR)" >> CHANGELOG.full.md
            echo "" >> CHANGELOG.full.md

            PR_BODY=$(gh api repos/$REPO/pulls/$PR --jq '.body')
            echo "$PR_BODY" >> CHANGELOG.full.md
            echo "" >> CHANGELOG.full.md

            # 2. detect referenced issues
            ISSUES=$(echo "$PR_BODY" | grep -oE 'Refs #[0-9]+' | tr -d 'Refs #' | sort -u)

            for ISSUE in $ISSUES; do
              echo "" >> CHANGELOG.full.md
              echo "### Issue #$ISSUE" >> CHANGELOG.full.md
              echo "" >> CHANGELOG.full.md
              gh api repos/$REPO/issues/$ISSUE --jq '.body' >> CHANGELOG.full.md
              echo "" >> CHANGELOG.full.md
            done
          done

      - name: Upload CHANGELOG.full.md to release
        uses: softprops/action-gh-release@v1
        with:
          files: CHANGELOG.full.md
